<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç™»å½•è¯Šæ–­</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;margin:0;padding:20px;line-height:1.5}
    h1{margin:0 0 12px;font-size:26px}
    input,button{width:100%;padding:10px;margin:6px 0;border-radius:10px;border:1px solid #ddd;font-size:16px}
    button{border:none;background:#111;color:#fff}
    button.ghost{background:#f2f2f2;color:#111}
    pre{background:#0b0b0c;color:#e5ffe5;padding:12px;border-radius:10px;white-space:pre-wrap;word-break:break-word;min-height:120px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width:480px){.row{grid-template-columns:1fr}}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:8px 14px;border-radius:8px;opacity:0;transition:.25s}
    .toast.show{opacity:1}
  </style>

  <!-- å¿…é¡»ï¼šUMD ç‰ˆ Supabase SDKï¼ˆæ”¾åœ¨ headï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
</head>
<body>
  <h1>ğŸŒ™ ç™»å½•è¯Šæ–­</h1>

  <input id="url"  placeholder="Supabase URLï¼ˆhttps://xxxx.supabase.coï¼‰">
  <input id="key"  placeholder="anon keyï¼ˆä»¥ eyJ... å¼€å¤´ï¼‰">
  <input id="email" placeholder="é‚®ç®±">

  <div class="row">
    <button id="btn-send">å‘é€éªŒè¯ç ï¼ˆç›´è¿ OTP APIï¼‰</button>
    <button id="btn-verify" class="ghost">éªŒè¯ï¼ˆè¾“å…¥ 6 ä½ç ï¼‰</button>
    <button id="btn-save" class="ghost">ä¿å­˜é…ç½®</button>
    <button id="btn-load" class="ghost">è½½å…¥é…ç½®</button>
  </div>

  <pre id="log">è¿™é‡Œä¼šæ‰“å° HTTP çŠ¶æ€ä¸ç»“æœã€‚</pre>
  <div class="toast" id="toast"></div>

  <script>
    // --- SDK æ˜¯å¦åŠ è½½ ---
    if(!window.supabase || !window.supabase.createClient){ alert('SDK æœªåŠ è½½'); }

    // --- å°å·¥å…· ---
    const $ = s => document.querySelector(s);
    const toastEl = $('#toast');
    const toast = m => { toastEl.textContent=m; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),1600); };
    const j = v => { try { return JSON.stringify(v,null,2);} catch{ return String(v);} };
    const norm = v => (v||'').trim();

    // --- è§£æ hashï¼ˆé‚®ä»¶å›è·³ç”¨ï¼‰---
    function getHashParams(){
      const h=(location.hash||'').replace(/^#/,''); const out={}; if(!h) return out;
      h.split('&').forEach(kv=>{ const [k,v]=kv.split('='); if(k) out[decodeURIComponent(k)] = decodeURIComponent(v||''); });
      return out;
    }

    async function handleRedirect(){
      const p = getHashParams();
      if(!Object.keys(p).length) return;

      const log = $('#log');
      log.textContent = 'Redirect payload:\n' + j(p);

      if(p.error){
        if(window.toast) toast(`Auth é”™è¯¯ï¼š${p.error} ${p.error_description||''}`);
        history.replaceState(null,'',location.pathname+location.search);
        return;
      }

      // ç”¨æœ¬æœºä¿å­˜çš„ URL/KEY å»ºä¼šè¯
      const URL = norm(localStorage.getItem('diag_url')||'').replace(/\/+$/,'');
      const KEY = norm(localStorage.getItem('diag_key')||'');
      if(URL && KEY && (p.access_token || p.refresh_token)){
        try{
          const sb = window.supabase.createClient(URL, KEY);
          const { data, error } = await sb.auth.setSession({
            access_token: p.access_token || '',
            refresh_token: p.refresh_token || ''
          });
          log.textContent += '\n\nsetSession result:\n' + j({data,error});
          if(!error) toast('Magic link ç™»å½•æˆåŠŸ');
        }catch(e){
          log.textContent += '\n\nsetSession exception: ' + String(e);
        }
      }
      history.replaceState(null,'',location.pathname+location.search);
    }
    document.addEventListener('DOMContentLoaded', handleRedirect);

    // --- ç›´è¿å‘é€ OTPï¼ˆå¼ºåˆ¶ 6 ä½éªŒè¯ç ï¼Œä¸èµ° magic linkï¼‰---
    async function sendDirect(){
      const URL = norm($('#url').value).replace(/\/+$/,'');
      const KEY = norm($('#key').value);
      const email = norm($('#email').value).toLowerCase();
      if(!URL || !KEY || !email){ toast('URL/KEY/é‚®ç®±éƒ½è¦å¡«'); return; }

      try{
        const res = await fetch(`${URL}/auth/v1/otp?type=email`, {
          method: 'POST',
          headers: {
            'Content-Type':'application/json',
            'apikey': KEY,
            'Authorization': `Bearer ${KEY}`
          },
          body: JSON.stringify({ email, create_user:true}) // å…³é”®
        });
        const body = await res.json().catch(()=>({}));
        $('#log').textContent = `HTTP ${res.status}\n` + j(body);
        toast(res.ok ? 'å·²å‘é€' : 'å¤±è´¥');
      }catch(e){
        $('#log').textContent = 'ç›´è¿å¼‚å¸¸ï¼š' + String(e);
        toast('å¼‚å¸¸');
      }
    }

    // --- éªŒè¯ OTP å¹¶ç™»å½• ---
    async function verify(){
      const URL = norm($('#url').value).replace(/\/+$/,'');
      const KEY = norm($('#key').value);
      const email = norm($('#email').value).toLowerCase();
      const token = prompt('è¾“å…¥é‚®ç®±æ”¶åˆ°çš„ 6 ä½éªŒè¯ç ');
      if(!URL || !KEY || !email || !token){ toast('å‚æ•°ä¸å®Œæ•´'); return; }

      const sb = window.supabase.createClient(URL, KEY);
      const { data, error } = await sb.auth.verifyOtp({ email, token, type:'email' });
      $('#log').textContent = j({ data, error });
      toast(error ? 'éªŒè¯å¤±è´¥' : 'éªŒè¯æˆåŠŸ');
    }

    // --- å­˜å–é…ç½® ---
    function saveLocal(){
      localStorage.setItem('diag_url', $('#url').value);
      localStorage.setItem('diag_key', $('#key').value);
      localStorage.setItem('diag_email', $('#email').value);
      toast('å·²ä¿å­˜');
    }
    function loadLocal(){
      $('#url').value   = localStorage.getItem('diag_url')   || '';
      $('#key').value   = localStorage.getItem('diag_key')   || '';
      $('#email').value = localStorage.getItem('diag_email') || '';
      toast('å·²è½½å…¥');
    }

    // äº‹ä»¶ç»‘å®š
    $('#btn-send').onclick   = sendDirect;
    $('#btn-verify').onclick = verify;
    $('#btn-save').onclick   = saveLocal;
    $('#btn-load').onclick   = loadLocal;
    loadLocal(); // è¿›å…¥é¡µå°±å°è¯•è½½å…¥ä¸€é
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Supabase OTP 诊断 · 双通道</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;margin:0;padding:20px;line-height:1.5}
    h1{margin:0 0 12px;font-size:24px}
    input,button{width:100%;padding:10px;margin:6px 0;border-radius:10px;border:1px solid #ddd;font-size:16px}
    button{border:none;background:#111;color:#fff}
    button.ghost{background:#f2f2f2;color:#111;border:1px solid #ddd}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width:520px){.row{grid-template-columns:1fr}}
    pre{background:#0b0b0c;color:#e5ffe5;padding:12px;border-radius:10px;white-space:pre-wrap;word-break:break-word;min-height:140px}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:8px 14px;border-radius:8px;opacity:0;transition:.25s}
    .toast.show{opacity:1}
  </style>

  <!-- UMD 版 SDK（必须先加载） -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
</head>
<body>
  <h1>🌙 Supabase OTP 诊断 · 双通道（SDK / REST）</h1>

  <input id="url"  placeholder="Supabase URL（https://xxxx.supabase.co）" />
  <input id="key"  placeholder="anon key（以 eyJ... 开头）" />
  <input id="email" placeholder="邮箱" />

  <div class="row">
    <button id="btn-send-sdk">发送验证码（SDK）</button>
    <button id="btn-send-rest" class="ghost">发送验证码（REST）</button>
    <button id="btn-verify" class="ghost">验证（输入6位码）</button>
    <button id="btn-save" class="ghost">保存配置</button>
    <button id="btn-load" class="ghost">载入配置</button>
  </div>

  <pre id="log">这里会打印 SDK/HTTP 返回、错误信息。</pre>
  <div class="toast" id="toast"></div>

  <script>
    if(!window.supabase || !window.supabase.createClient){ alert('SDK 未加载'); }

    const $ = s => document.querySelector(s);
    const toastEl = $('#toast');
    const toast = m => { toastEl.textContent=m; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),1600); };
    const j = v => { try { return JSON.stringify(v,null,2);} catch { return String(v);} };
    const norm = v => (v||'').trim();

    function saveLocal(){
      localStorage.setItem('diag_url', $('#url').value);
      localStorage.setItem('diag_key', $('#key').value);
      localStorage.setItem('diag_email', $('#email').value);
      toast('已保存');
    }
    function loadLocal(){
      $('#url').value   = localStorage.getItem('diag_url')   || '';
      $('#key').value   = localStorage.getItem('diag_key')   || '';
      $('#email').value = localStorage.getItem('diag_email') || '';
      toast('已载入');
    }

    // —— SDK 发送 OTP（文档推荐写法）——
    async function sendOtpSDK(){
      const URL = norm($('#url').value).replace(/\/+$/,'');
      const KEY = norm($('#key').value);
      const email = norm($('#email').value).toLowerCase();
      if(!URL||!KEY||!email){ toast('URL/KEY/邮箱都要填'); return; }

      const sb = window.supabase.createClient(URL, KEY);
      const { data, error } = await sb.auth.signInWithOtp({
        email,
        options: { shouldCreateUser: true } // 不设置 redirectTo，避免触发 magic link 跳转
      });
      $('#log').textContent = 'SDK signInWithOtp →\n' + j({ data, error });
      toast(error ? 'SDK 发送失败' : 'SDK 已发送');
    }

    // —— REST 发送 OTP（等价写法）——
    async function sendOtpREST(){
      const URL = norm($('#url').value).replace(/\/+$/,'');
      const KEY = norm($('#key').value);
      const email = norm($('#email').value).toLowerCase();
      if(!URL||!KEY||!email){ toast('URL/KEY/邮箱都要填'); return; }

      try{
        const res = await fetch(`${URL}/auth/v1/otp`, {
          method: 'POST',
          headers: {
            'Content-Type':'application/json',
            apikey: KEY,
            Authorization: `Bearer ${KEY}`
          },
          // 关键：type:'email' 明确要求邮件验证码；不带任何 redirect/magiclink 字段
          body: JSON.stringify({ email, create_user:true, type:'email' })
        });
        const body = await res.json().catch(()=>({}));
        $('#log').textContent = `REST /otp → HTTP ${res.status}\n` + j(body);
        toast(res.ok ? 'REST 已发送' : 'REST 发送失败');
      }catch(e){
        $('#log').textContent = 'REST 发送异常：' + String(e);
        toast('异常');
      }
    }

    // —— 验证 6 位验证码 —— 
    async function verify(){
      const URL = norm($('#url').value).replace(/\/+$/,'');
      const KEY = norm($('#key').value);
      const email = norm($('#email').value).toLowerCase();
      const token = prompt('输入邮箱收到的 6 位验证码');
      if(!URL||!KEY||!email||!token){ toast('参数不完整'); return; }

      const sb = window.supabase.createClient(URL, KEY);
      const { data, error } = await sb.auth.verifyOtp({ email, token, type:'email' });
      $('#log').textContent = 'verifyOtp →\n' + j({ data, error });
      toast(error ? '验证失败' : '验证成功');
    }

    // 绑定
    $('#btn-send-sdk').onclick  = sendOtpSDK;
    $('#btn-send-rest').onclick = sendOtpREST;
    $('#btn-verify').onclick    = verify;
    $('#btn-save').onclick      = saveLocal;
    $('#btn-load').onclick      = loadLocal;
    loadLocal();
  </script>
</body>
</html>
